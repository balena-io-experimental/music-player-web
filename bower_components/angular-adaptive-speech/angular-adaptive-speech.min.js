/*!
 * angular-adaptive-speech v0.2.0
 * The MIT License
 * Copyright (c) 2013 Jan Antala
 */
!function(){var a=angular.module("adaptive.speech",[]);a.value("DEST_LANG","en-US"),a.factory("$speechRecognition",["$rootScope","DEST_LANG",function(a,b){var c=function(){this.start=function(){this.onerror({code:0,error:"speech recognition is not supported"})}.bind(this),this.stop=function(){this.onerror({code:0,error:"speech recognition is not supported"})}.bind(this)};window.SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition||c;var d,e=function(){d=new window.SpeechRecognition,d.continuous=!0,d.interimResults=!0,d.maxAlternatives=3,d.onresult=function(a){p&&p(a)},d.onstart=function(a){console.log("listening..."),f&&f(a)},d.onend=function(a){o&&o(a)},d.onerror=function(a){console.log(a),g&&g(a)}};e();var f,g,h=!1,i=!1,j=!1,k=function(a){if(!a)return!1;var c=["http://www.corsproxy.com/","translate.google.com/translate_tts?ie=UTF-8&q=",a,"&tl=",b].join(""),d=new Audio;d.addEventListener("play",function(){console.log("isSpeaking start")},!1),d.addEventListener("ended",function(){j=!0,console.log("isSpeaking end")},!1),d.addEventListener("error",function(){console.log("error"),console.log("isSpeaking end")},!1),d.autoplay=!0,d.src=c},l=function(){i||(e(),d.start(),console.log(d)),i=!0},m=function(){i&&(d.stop(),console.log(d)),i=!1},n=function(a){b=a,d.lang=a},o=function(){h=!1,d=null},p=function(c){if(c.results.length){var d=c.results[c.resultIndex];if(d.isFinal){if(j)return j=!1,!1;var e=d[0].transcript.trim();h&&(console.log(d),console.log('utterance: "'+e+'"'),a.$broadcast("adaptive.speech:utterance",{lang:b,utterance:e}))}}},q=function(c){return a.$on("adaptive.speech:utterance",function(a,d){var e=[];angular.isArray(c)?e=c:e.push(c),e.forEach(function(a){if(console.log(d),console.log(a),a.lang!==b)return!1;var c=a.regex||null,e=d.utterance;console.log(c,e.match(c)),e.match(c)&&a.call(e)})})};return{onstart:function(a){f=a},onerror:function(a){g=a},setLang:function(a){n(a)},getLang:function(){return b},speak:function(a){k(a)},payAttention:function(){h=!0},ignore:function(){h=!1},listen:function(){l()},stopListening:function(){m()},listenUtterance:function(a){return q(a)}}}]),a.directive("speechrecognition",["$rootScope","DEST_LANG",function(a,b){return{restrict:"A",link:function(c,d,e){var f=function(){return angular.extend({},c.$eval(e.speechrecognition))},g=f();console.log(g),a.$on("adaptive.speech:utterance",function(a,c){var d=[];angular.isArray(g.tasks)?d=g.tasks:d.push(g.tasks),console.log(c),d.forEach(function(a){if(a.lang!==b)return!1;var d=a.regex||null,e=c.utterance;e.match(d)&&e.match(new RegExp(g.thing,"ig"))&&(console.log(d,e.match(d),e.match(new RegExp(g.thing,"ig"))),a.call(e))})})}}}])}();