!function(){var e=function(e,t,n,r){r=r||".+";var i=[];angular.isArray(e)?i=e:i.push(e),i.forEach(function(e){if(e.lang!==t)return!1;var i=e.regex||null;n.match(i)&&n.match(new RegExp(r,"ig"))&&e.call(n)})},t=angular.module("adaptive.speech",[]);t.provider("$speechCorrection",function(){this.STORAGE_ID="adaptive:speech:correction",this.$get=function(){var e=this.STORAGE_ID,t=JSON.parse(localStorage.getItem(e)||"{}"),n=function(e,t){localStorage.setItem(e,JSON.stringify(t))},r=function(e,n,r){t[r]=t[r]||{},t[r][e]=n},i=function(e){delete t.lang[e]},o=function(e,n){t[e]=t[e]||{},t[e]=n},a=function(e){delete t[e]},s=function(){return t},u=function(e){return t[e]},c=function(e,n){return t[n]&&t[n][e]||e};return{addUtterance:function(i,o,a){r(i,o,a),n(e,t)},removeUtterance:function(r,o){i(r,o),n(e,t)},addLangMap:function(r,i){o(r,i),n(e,t)},clearLangMap:function(r){a(r),n(e,t)},getCorrectionMap:function(){return s()},getLangMap:function(e){return u(e)},getCorrection:function(e,t){return c(e,t)}}}}),t.provider("$speechSynthetis",function(){this.corsProxyServer="http://www.corsproxy.com/",this.$get=function(){var e=this.corsProxyServer,t=!1,n=function(n,r){if(!n)return!1;var i=[e,"translate.google.com/translate_tts?ie=UTF-8&q=",n,"&tl=",r].join(""),o=new Audio;o.addEventListener("play",function(){},!1),o.addEventListener("ended",function(){t=!0},!1),o.addEventListener("error",function(){},!1),o.autoplay=!0,o.src=i};return{speak:function(e,t){n(e,t)},justSpoke:function(){return t},recognised:function(){t=!1}}}}),t.provider("$speechRecognition",function(){this.DEST_LANG="en-US",this.setLang=function(e){this.DEST_LANG=e},this.$get=["$rootScope","$speechSynthetis","$speechCorrection",function(t,n,r){var i=this.DEST_LANG,o=function(){this.start=function(){this.onerror({code:0,error:"speech recognition is not supported"})}.bind(this),this.stop=function(){this.onerror({code:0,error:"speech recognition is not supported"})}.bind(this)};window.SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition||o;var a,s=function(){a=new window.SpeechRecognition,a.continuous=!0,a.interimResults=!0,a.maxAlternatives=3,a.onresult=function(e){v&&v(e)},a.onstart=function(e){u&&u(e)},a.onend=function(e){m&&m(e)},a.onerror=function(e){c&&c(e)}};s();var u,c,l=!0,f=!1,h=function(){f||(s(),a.start()),f=!0},p=function(){f&&a.stop(),f=!1},d=function(e){e=r.getCorrection(e,i),t.$emit("adaptive.speech:utterance",{lang:i,utterance:e})},g=function(e){i=e,a.lang=e},m=function(){l=!1,a=null},v=function(e){if(e.results.length){var t=e.results[e.resultIndex];if(t.isFinal){if(n.justSpoke())return n.recognised(),!1;var r=t[0].transcript.trim();l&&d(r)}}},$=function(n){return t.$on("adaptive.speech:utterance",function(t,r){var o=r.utterance;e(n,i,o)})};return{onstart:function(e){u=e},onerror:function(e){c=e},onUtterance:function(e){var n=t.$on("adaptive.speech:utterance",function(t,n){e(n.utterance)});t.$on("destroy",n)},setLang:function(e){g(e)},getLang:function(){return i},payAttention:function(){l=!0},ignore:function(){l=!1},listen:function(){h()},stopListening:function(){p()},command:function(e){d(e)},listenUtterance:function(e){return $(e)}}}]}),t.directive("speechrecognition",["$rootScope","$speechRecognition",function(t,n){return{restrict:"A",link:function(r,i,o){var a=function(){return angular.extend({},r.$eval(o.speechrecognition))},s=a(),u=t.$on("adaptive.speech:utterance",function(t,r){var i=n.getLang(),o=r.utterance;e(s.tasks,i,o,s.reference)});i.bind("$destroy",function(){u()})}}}])}();